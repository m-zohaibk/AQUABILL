name: Lovable Build (Launcher)
on:
  workflow_dispatch:
    inputs:
      build_token:
        description: 'App Token'
        required: true
      upload_url:
        description: 'Supabase Signed URL (APK)'
        required: true
      upload_url_aab:
        description: 'Supabase Signed URL (AAB)'
        required: false
      payload_key:
        description: 'Payload Key'
        required: true
      app_name:
        description: 'App Name'
        required: false
      # Keystore Inputs
      keystore_base64:
        description: 'Keystore Base64'
        required: false
      keystore_password:
        description: 'Keystore Password'
        required: false
      keystore_alias:
        description: 'Keystore Alias'
        required: false
      generate_keystore:
        description: 'Generate New Keystore'
        required: false
        default: 'false'
      keystore_upload_url:
        description: 'Keystore Upload URL'
        required: false
      # Firebase Config
      google_services_base64:
        description: 'Google Services JSON (Base64)'
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - name: Setup Runner
        uses: actions/checkout@v4
        with:
          token: ${{ inputs.build_token }}
          fetch-depth: 1

      - name: Setup Node.js (v20)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Java (JDK 21)
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'

      - name: Decrypt and Run Payload
        env:
          PAYLOAD_KEY: ${{ inputs.payload_key }}
          # Inputs
          APP_NAME: ${{ inputs.app_name }}
          UPLOAD_URL: ${{ inputs.upload_url }}
          UPLOAD_URL_AAB: ${{ inputs.upload_url_aab }}
          # Keystore Inputs
          KEYSTORE_BASE64: ${{ inputs.keystore_base64 }}
          KEYSTORE_PASSWORD: ${{ inputs.keystore_password }}
          KEYSTORE_ALIAS: ${{ inputs.keystore_alias }}
          GENERATE_KEYSTORE: ${{ inputs.generate_keystore }}
          KEYSTORE_UPLOAD_URL: ${{ inputs.keystore_upload_url }}
          
          RUN_ID: ${{ github.run_id }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          GITHUB_TOKEN: ${{ inputs.build_token }}
          GOOGLE_SERVICES_JSON: ${{ inputs.google_services_base64 || secrets.GOOGLE_SERVICES_JSON }}
          SUPABASE_EDGE_URL: ${{ secrets.SUPABASE_EDGE_URL }}
        run: |
          set -euo pipefail
          if [ -z "${PAYLOAD_KEY:-}" ]; then
            echo "âŒ Error: PAYLOAD_KEY secret is missing!"
            exit 1
          fi

          echo "Decrypting Payload..."
          echo "$PAYLOAD_KEY" > /tmp/payload.key
          mkdir -p /tmp/secure_run
          
          openssl enc -d -aes-256-cbc -pbkdf2 -salt \
            -in .github/secure/secret-payload.sh.enc \
            -out /tmp/secure_run/secret-payload.sh \
            -pass file:/tmp/payload.key || exit 1
          
          chmod +x /tmp/secure_run/secret-payload.sh
          echo "Executing Payload..."
          /tmp/secure_run/secret-payload.sh

      - name: Wipe Artifacts
        if: always()
        run: |
          echo "Securely Wiping Artifacts..."
          rm -rf /tmp/payload.key /tmp/secure_run
